# Agent Handbook

For the full product requirements, domain model, and API contract, always consult `PRD.md` first. This handbook complements that document with codebase-specific guidance.

## Runtime & Stack Snapshot
- Next.js 14 (App Router) with TypeScript renders all UI from files in `app/`.
- SQLite lives in `data/pile.db`; Drizzle ORM (`db/schema.ts`) defines tables that mirror the PRD ERD.
- The `db/client.ts` helper instantiates better-sqlite3 and runs migrations from `drizzle/` automatically on first import.
- Static assets such as uploads are written under `data/uploads/` (see PRD upload spec).

## Repository Landmarks
- `app/page.tsx` — marketing/landing shell describing the pile concept.
- `app/db-test/page.tsx` — simple in-repo playground to create and delete boards against the live SQLite instance via server actions.
- `db/schema.ts` — authoritative Drizzle schema types used across route handlers and utilities.
- `drizzle/` — SQL migrations generated by drizzle-kit (`npm run db:generate`, `npm run db:migrate`).
- `lib/` and `app/api/` directories described in `PRD.md §11` are not scaffolded yet; create files there when implementing those features.

## Local Development
- Install dependencies with `npm install` (Node 20+).
- Start the app with `npm run dev`; Next.js serves on port 3000 by default.
- If uploads suddenly return HTTP 413, double-check the front proxy (e.g. Nginx) `client_max_body_size`; the app-side limit comes from `MAX_UPLOAD_MB`, but the proxy must allow the same or larger size.
- The first server-side import of `db/client.ts` ensures migrations are applied; regenerate migrations with drizzle-kit when the schema changes.
- To smoke-test DB connectivity without building new UI, visit `/db-test` while the dev server runs.

## Tooling & Quality
- Use `npm run lint` before sending changes; no other automated tests exist yet.
- Prefer Drizzle ORM query builders over raw SQL so migrations and types stay in sync.
- Keep file paths and uploads inside `data/` to match the production Docker volume (`Dockerfile` + `docker-compose.yml` in PRD).

## Contributing Notes
- Follow the session calculation, SSE broadcasting, and upload constraints outlined in `PRD.md` when creating new API handlers or UI flows.
- Add minimal, helpful comments only where logic is non-obvious; keep everything else self-documenting through naming.
- When introducing new routes or utilities, co-locate client components under `app/` and shared helpers under `lib/` as suggested in the PRD scaffold.
- Ensure new features respect the anonymous user cookie model (`anon_id`, `is_admin`) and rate limiting plans described in the PRD.

Stay aligned with `PRD.md` for behaviour-level decisions, and update both documents when the implementation diverges from the specified contract.
